@inherits CipherTableCard

@inject DialogService DialogService

<CipherTableCard Title="@Title" MaxWidth="@MaxWidth" Width="@Width" WithCard="@WithCard" WithButtons="@WithButtons"
                 Sharable="@Sharable" IsReport="@IsReport" CsvDataFetch="SetData" CipherType="typeof(Package)"
                 FileTitle="@FileTitle" ExcelExport=@ExcelExport PDFExport=@PDFExport ExpandPath="@ExpandPath" Height="@Height" MarginBottom="@MarginBottom">
    <AdditionalButtons>
        <CipherAddPackageBtn />
    </AdditionalButtons>
    <HeaderContent>
        @if (WithHeaderContent)
        {
            <RadzenStack AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Stretch">
                <CipherLocation WithIcon=false Label="בחירת מערכת" Change="SearchFunc" @ref="SelectedSystem"/>
            </RadzenStack>
        }
    </HeaderContent>
    <ComponentContent>
        <CipherDataGrid @ref=DataGrid Cipher_TItem="PackageDTO" DataSource="@_ChosenObjectsDTOs" RowsPerPage="@RowsPerPage" ColumnNames="@(new Package().Headers())"
                        GridFilterMode="@GridFilterMode" AllowFilter="@AllowFilter" AllowGroup="@AllowGroup"
                        WithTotalFooter="@AllowTotalFooter" />
    </ComponentContent>
</CipherTableCard>

@code {
    private IEnumerable<Package> _ChosenObjects = new List<Package>();
    private List<PackageDTO> _ChosenObjectsDTOs = new();

    /// <summary>
    /// Error result of events fetching.
    /// </summary>
    [Parameter]
    public ErrorResponse Error { get; set; } = ErrorResponse.Success;

    /// <summary>
    /// Filter mode of data grid. Must be a FilterMode-enum.
    /// </summary>
    [Parameter]
    public FilterMode GridFilterMode { get; set; } = FilterMode.SimpleWithMenu;

    /// <summary>
    /// Is datagrid filterable
    /// </summary>
    [Parameter]
    public bool AllowFilter { get; set; }

    /// <summary>
    /// Is datagrid groupable.
    /// </summary>
    [Parameter]
    public bool AllowGroup { get; set; }

    /// <summary>
    /// Is total footer of decimal values (such as sum of mass) allowed.
    /// </summary>
    [Parameter]
    public bool AllowTotalFooter { get; set; } = true;

    /// <summary>
    /// Is a CipherAutoComplete header is needed.
    /// </summary>
    [Parameter]
    public bool WithHeaderContent { get; set; } = true;

    /// <summary>
    /// Max amount of rows per page of datagrid.
    /// </summary>
    [Parameter]
    public int RowsPerPage { get; set; } = 12;

    /// <summary>
    /// All packages available
    /// </summary>
    [Parameter]
    public IEnumerable<Package> ChosenObjects
    {
        get => _ChosenObjects;
        set { _ChosenObjects = value; _ChosenObjectsDTOs = value.Select(x => x.ToDTO()).ToList(); }
    }

    private CipherLocation SelectedSystem = new();

    private CipherDataGrid<PackageDTO> DataGrid = new();

    protected override void OnInitialized()
    {
        Title ??= "דוח תעודות";
        SetFileTitle();
        SearchFunc();
    }

    /// <summary>
    /// Function taking place upon clicking Enter.s
    /// </summary>
    private void SearchFunc()
    {
        if (SelectedSystem.ChosenSystem is null)
        {
            ChosenObjects = new List<Package>();
        }
        else
        {
            (ChosenObjects, Error) = SelectedSystem.ChosenSystem.Packages();
        }
        SetFileTitle();
        StateHasChanged();
    }

    public void SetFileTitle() => FileTitle = $"packages_{SelectedSystem.ChosenSystem?.Id}";

    public IEnumerable<IDictionary<string, object>> SetData() => DataGrid.GetPagedData();

    async Task ShowError()
    {
        await DialogService.OpenAsync("שגיאת מערכת",
        ds =>
    @<CipherErrorCard ErrorType="@Error.Message" ErroredAction="@SelectedSystem.ChosenSystem?.Name" Visible=@(Error != ErrorResponse.Success) MarginTop="10px" MarginBottom="10px" />
        , new DialogOptions() { Width = "800px", Height = "250px", Resizable = true, Draggable = true });
    }
}