@inject DialogService DialogService

@inherits CipherComponentCard

@code {
    /// <summary>
    /// Text alignment. Must be a TextAlign-enum.
    /// </summary>
    [Parameter]
    public TextAlign TdTextAlign { get; set; } = TextAlign.Right;

    /// <summary>
    /// Text that will be shown if there are no parameters in memory.
    /// </summary>
    [Parameter]
    public string HelpText { get; set; } = "במסך זה ניתן להוסיף פרמטרים אותם יצטרך להזין המשתמש. להוספה לחצו על כפתור ההוספה למעלה";

    public class Parameter
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string pType { get; set; }
    }

    public class Attribute
    {
        public string Class { get; set; }
        public string ParameterName { get; set; }
        public string Path { get; set; }

        public Attribute(string att_class, string att_param_name)
        {
            Class = att_class;
            ParameterName = att_param_name;
            Path = $"{Class}.{ParameterName}";
        }
    }

    private RadzenDataGrid<Parameter> CustomDataGrid = new RadzenDataGrid<Parameter>();

    private List<Attribute> OptionalTypes = new List<Attribute>();
    private List<Parameter> set_params = new List<Parameter>() { };
    private Parameter old_param = new Parameter();

    int components = 0;

    protected override async void OnInitialized()
    {
        Title ??= "פרמטרי משתמש";

        AddTypeAttributes(typeof(Package), "אריזה");
        AddTypeAttributes(typeof(Vessel), "כלי");
        AddTypeAttributes(typeof(StorageSystem), "מיקום");
        AddTypeAttributes(typeof(Category), "קטגוריה");
        AddTypeAttributes(typeof(Event), "תנועה");
        AddTypeAttributes(typeof(Process), "תהליך");
    }

    /// <summary>
    /// Adds all available attributes of a specific data-model.
    /// </summary>
    /// <param name="type"></param>
    /// <param name="type_heb_name"></param>
    private void AddTypeAttributes(Type type, string type_heb_name)
    {
        List<Tuple<string, string>> typeAttributes = CommonFuncs.GetTranslatedFields(type);

        foreach (Tuple<string, string> att in typeAttributes)
        {
            OptionalTypes.Add(new Attribute(type_heb_name, att.Item2));
        }
    }

    /// <summary>
    /// Add a parameter to the memory.
    /// </summary>
    async Task AddComponent()
    {
        if (components == set_params.Count)
        {
            int next_id = components + 1;
            Parameter new_param = new Parameter() { Id = next_id };

            set_params.Add(new_param);
            StateHasChanged();

            components = set_params.Count;

            await CustomDataGrid.RefreshDataAsync();
        }
    }

    /// <summary>
    /// Deletes a parameter from memory & view.
    /// </summary>
    /// <param name="param"></param>
    /// <returns></returns>
    async Task DeleteRow(Parameter param)
    {
        set_params.Remove(param);

        CustomDataGrid.Data = set_params;

        components --;

        await CustomDataGrid.RefreshDataAsync();
    }

    /// <summary>
    /// Clears all parameters from memory & view.
    /// </summary>
    /// <returns></returns>
    async Task DeleteAll()
    {
        set_params = new List<Parameter>();
        components = 0;
        CustomDataGrid.Data = set_params;

        await CustomDataGrid.RefreshDataAsync();
    }
}

<CipherComponentCard Title="@Title">
    <Buttons>
        <CipherAddBtn Variant="Variant.Outlined" Click="@(args => AddComponent())" HelpText="הוספת פרמטר" />
        <CipherButton Icon="@Icons.Documents.Delete.delete_sweep" Variant="Variant.Outlined" Click="@(args => DeleteAll())" HelpText="מחיקת פרמטרים" />
    </Buttons>

    <ChildContent>
        @if (set_params.Count() == 0)
        {
            <CipherText Text="@HelpText"/>
        }
        <RadzenDataGrid @ref="CustomDataGrid" Data="set_params" TItem="Parameter" AllowColumnResize="true" Visible="set_params.Count() != 0">
            <Columns>
                <RadzenDataGridColumn Width="10%" TItem="Parameter" Title="פעולות" Filterable="false" Sortable="false" TextAlign="@TdTextAlign">
                    <Template Context="param">
                        <CipherDeleteButton Variant=Variant.Outlined Click="@(args => DeleteRow(param))" @onclick:stopPropagation="true" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Parameter" Property="Id" Title="#" TextAlign="@TdTextAlign" Width="5%" />
                <RadzenDataGridColumn TItem="Parameter" Property="Name" Title="שם" TextAlign="@TdTextAlign" Width="40%">
                    <Template Context="param">
                        <CipherAutoComplete @bind-Value="@param.Name" Width="100%" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Parameter" Property="pType" Title="סוג" TextAlign="@TdTextAlign" Width="45%">
                    <Template Context="param">
                        <RadzenDropDownDataGrid @bind-Value=@param.pType Data=@OptionalTypes TextProperty="Path" ValueProperty="Path"
                                                Placeholder="חיפוש פרמטר" SearchTextPlaceholder="חיפוש..." AllowSorting=false
                                                AllowColumnResize="true" AllowFilteringByAllStringColumns="true">
                            <Columns>
                                <RadzenDropDownDataGridColumn Property="Class" Title="קטגוריה" OrderIndex="1" />
                                <RadzenDropDownDataGridColumn Property="ParameterName" Title="שם פרמטר" OrderIndex="2" />
                            </Columns>
                        </RadzenDropDownDataGrid>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </ChildContent>
</CipherComponentCard>