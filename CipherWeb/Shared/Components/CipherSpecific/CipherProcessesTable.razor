@inject ICipherInfo _db

@using OfficeOpenXml
@using System.IO
@using OfficeOpenXml.Core.ExcelPackage;
@inject NavigationManager Navigation

@inherits CipherTableCard

<CipherTableCard Title="@Title" DataSource="@values()" Variant="@Variant" WithCard="@WithCard" WithButtons="@WithButtons" Sharable="@Sharable" IsReport="@IsReport">
    <AdditionalButtons>
        <CipherNavButton Icon="@Icons.Symbols.Plus.AddCircleOutline" Path="@CipherNavLinks.AddProcess.Href" HelpText="הוספת תהליך" Variant="Variant.Outlined" />
    </AdditionalButtons>
    <HeaderContent>
        @if (WithHeaderContent)
        {
            <RadzenStack AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Stretch">
                <CipherLocation Label="בחירת מיקום / תחום / מבנה" />
            </RadzenStack>
        }
    </HeaderContent>
    <ComponentContent>
        <CipherDataGrid Cipher_TItem="Process" DataSource="@Processes" WithCustomColumns="true" @ref=datagrid
                        GridFilterMode="@FilterMode" AllowFilter="@AllowFilter" AllowGroup="@AllowGroup">
            <CustomColumns>
                <RadzenDataGridColumn TItem="Process" Property="@(nameof(CachedData.ProcessExample.Id))" Title="@(Process.Translate(nameof(CachedData.ProcessExample.Id)))">
                    <FooterTemplate>
                        <b>סה"כ תהליכים:</b> @Processes.Count()
                    </FooterTemplate>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Process" Property="@(nameof(CachedData.ProcessExample.Definition.Name))" Title="@(ProcessDefinition.Translate(nameof(CachedData.ProcessExample.Definition.Name)))">
                    <Template>
                        @context.Definition.Name
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Process" Property="@(nameof(CachedData.ProcessExample.UncompletedSteps))" Title="@(Process.Translate(nameof(CachedData.ProcessExample.UncompletedSteps)))">
                    <Template>
                        @(string.Join(", ", context.UncompletedSteps.Select(x => x.Name).ToList()))
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Process" Property="@(nameof(CachedData.ProcessExample.Start))" Title="@(Process.Translate(nameof(CachedData.ProcessExample.Start)))" />
                <RadzenDataGridColumn TItem="Process" Property="@(nameof(CachedData.ProcessExample.End))" Title="@(Process.Translate(nameof(CachedData.ProcessExample.End)))" />
            </CustomColumns>
        </CipherDataGrid>
    </ComponentContent>
</CipherTableCard>

@code {
    /// <summary>
    /// Filter mode of the datagrid. Must be a FilterMode-enum.
    /// </summary>
    [Parameter]
    public FilterMode FilterMode { get; set; } = FilterMode.SimpleWithMenu;

    /// <summary>
    /// Is the datagrid filterable.
    /// </summary>
    [Parameter]
    public bool AllowFilter { get; set; } = false;

    /// <summary>
    /// Is the datagrid groupable.
    /// </summary>
    [Parameter]
    public bool AllowGroup { get; set; } = false;

    /// <summary>
    /// Is a CipherAutoComplete header is needed.
    /// </summary>
    [Parameter]
    public bool WithHeaderContent { get; set; } = true;

    /// <summary>
    /// All events for scheduler
    /// </summary>
    [Parameter]
    public IEnumerable<Process> Processes { get; set; } = new List<Process>();

    /// <summary>
    /// Error response for fetching data
    /// </summary>
    [Parameter]
    public ErrorResponse error { get; set; } = ErrorResponse.Success;

    private CipherDataGrid<Process> datagrid = new CipherDataGrid<Process>();

    protected override void OnInitialized()
    {
        Title ??= "דוח תהליכים";

        if (Processes is null)
        {
            (Processes, error) = CachedData.AllProcesses;
        }
    }

    public IEnumerable<object> values()
    {
        return datagrid.View;
    }
}