@if (WithFilter)
{
    <CipherComponentCard Title="נא לבחור אובייקטים לתצוגה" ContentJustify="center" ContentDisplay="flex">
        <RadzenSelectBar @bind-Value="@_ChosenId" Multiple="false" TValue="int" 
        Change="@(async args => {ChosenCondition = new GroupedBooleanCondition() ; await ParamsChanged();})">
            <Items>
                @foreach (string objType in objectTypes)
                {
                    <RadzenSelectBarItem Text="@objType" Value="@objectTypes.IndexOf(objType)" />
                }
            </Items>
        </RadzenSelectBar>
    </CipherComponentCard>
    <CipherBooleanConditions @ref="DataFilter" ChosenCondition="@ChosenCondition" OnSave="@SetCondition" AvailableAttributes="@(CommonFuncs.GetCipherTypeFields(GetReportType()))" ChosenConditionChanged="@ParamsChanged" />
}
@RenderCipherDataTable()

@code {
    private Type _ChosenType = typeof(Package);
    private int _ChosenId = 0;

    [Parameter]
    public Type ChosenType { get => _ChosenType; set { _ChosenType = value; SetType(); } }

    [Parameter]
    public List<string> objectTypes { get; set; } = new() {
        Translator.GetTranslation("Packages"),
        Translator.GetTranslation("Vessels"),
        Translator.GetTranslation("Systems"),
        Translator.GetTranslation("Events"),
        Translator.GetTranslation("Processes"),
        Translator.GetTranslation("Categories"),
        Translator.GetTranslation("Units"),
                };

    [Parameter]
    public bool WithFilter { get; set; } = true;

    /// <summary>
    /// Controls visibility of buttons within the datagridtable component
    /// </summary>
    [Parameter]
    public bool WithButtons { get; set; } = true;

    [Parameter]
    public ErrorResponse Error { get; set; } = ErrorResponse.Success;

    [Parameter]
    public IGroupedBooleanCondition ChosenCondition { get; set; } = new GroupedBooleanCondition();

    [Parameter]
    public EventCallback<Tuple<IGroupedBooleanCondition, Type>> ChosenConditionChanged { get; set; }

    private CipherBooleanConditions DataFilter = new();

    private List<IPackage>? Packages;
    private List<IVessel>? Vessels;
    private List<IStorageSystem>? Systems;
    private List<IEvent>? Events;
    private List<IProcess>? Processes;
    private List<ICategory>? Categories;
    private List<IUnit>? Units;

    public int GetTypeId(Type t)
    {
        if (t == typeof(IPackage)) return 0;
        if (t == typeof(IVessel)) return 1;
        if (t == typeof(IStorageSystem)) return 2;
        if (t == typeof(IEvent)) return 3;
        if (t == typeof(IProcess)) return 4;
        if (t == typeof(ICategory)) return 5;
        if (t == typeof(IUnit)) return 6;
        return 0;
    }

    public void SetType()
    {
        _ChosenId = GetTypeId(ChosenType);
    }

    public Type GetReportType() => _ChosenId switch
    {
        0 => typeof(IPackage),
        1 => typeof(IVessel),
        2 => typeof(IStorageSystem),
        3 => typeof(IEvent),
        4 => typeof(IProcess),
        5 => typeof(ICategory),
        6 => typeof(IUnit),
        _ => typeof(ICipherClass)
    };

    public async Task PreloadDataAsync()
    {
        Packages = await GetFilteredObjects<IPackage>();
        Vessels = await GetFilteredObjects<IVessel>();
        Systems = await GetFilteredObjects<IStorageSystem>();
        Events = await GetFilteredObjects<IEvent>();
        Processes = await GetFilteredObjects<IProcess>();
        Categories = await GetFilteredObjects<ICategory>();
        Units = await GetFilteredObjects<IUnit>();
    }

    public async Task<RenderFragment?> RenderCipherDataTable(int id)
    {
        await PreloadDataAsync();

        // Define the RenderFragment based on the id
        return id switch
        {
        0 => builder =>
        {
            builder.OpenComponent<CipherPackagesTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Packages);
            builder.AddAttribute(2, "WithButtons", WithButtons);
            builder.CloseComponent();
        },
        1 => builder =>
        {
            builder.OpenComponent<CipherVesselsTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Vessels);
            builder.CloseComponent();
        },
        2 => builder =>
        {
            builder.OpenComponent<CipherSystemsTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Systems);
            builder.CloseComponent();
        },
        3 => builder =>
        {
            builder.OpenComponent<CipherEventsTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Events);
            builder.CloseComponent();
        },
        4 => builder =>
        {
            builder.OpenComponent<CipherProcessesTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Processes);
            builder.CloseComponent();
        },
        5 => builder =>
        {
            builder.OpenComponent<CipherCategoriesTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Categories);
            builder.CloseComponent();
        },
        6 => builder =>
        {
            builder.OpenComponent<CipherUnitsTable>(0);
            builder.AddAttribute(1, "ChosenObjects", Units);
            builder.CloseComponent();
        },
        _ => builder =>
        {
            builder.AddContent(0, "No matching table found.");
        }
    };
    }

    public async Task<RenderFragment?> RenderCipherDataTable(Type type)
    {
        int id = GetTypeId(type);
        return await RenderCipherDataTable(id);
    }

    public async Task<RenderFragment?> RenderCipherDataTable() => await RenderCipherDataTable(_ChosenId);

    public async Task<List<T>> GetFilteredObjects<T>() where T : IResource
    {
        List<T> objects = new();
        ObjectFactory obj = new() { Filter = ChosenCondition };
        (objects, Error) = await Config.QueryRequests.QueryObjects<T>(obj);
        return objects;
    }

    /// <summary>
    /// Method to set the chosen condition accourding to DataFilter data
    /// </summary>
    public void SetCondition() => ChosenCondition = DataFilter.ChosenCondition;


    /// <summary>
    /// Events that occurs once something in the component changes.
    /// </summary>
    /// <returns></returns>
    async Task ParamsChanged()
    {
        Type oldChosenType = ChosenType;
        ChosenType = GetReportType();

        if (oldChosenType != ChosenType)
        {
            ChosenCondition = new GroupedBooleanCondition();
            await DataFilter.Clear();
        }
        await ChosenConditionChanged.InvokeAsync(Tuple.Create(ChosenCondition, ChosenType)); // Trigger change event
    }
}
