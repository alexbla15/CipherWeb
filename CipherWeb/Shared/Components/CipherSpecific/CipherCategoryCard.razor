@inherits CipherComponentCard

<CipherComponentCard WithCard="false" Title="@Title" ContentStyleClass="@Constants.Styles.ComponentResourceCardContent">
    <HeaderContent>
        @if (SetMode != FormMode.Create)
        {
            <RadzenStack AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
                <CipherCategoryDropDown Change="@Change" @ref="CatId" ChosenCategory="@ChosenObject" />
            </RadzenStack>
        }
    </HeaderContent>
    <ChildContent>
        @if (!(SetMode != FormMode.Create && ChosenObject is null))
        {
            <CipherComponentCard Title="תכונות" WithCard="true" 
            ContentStyleClass="@Constants.Styles.ComponentResourceCardContent_Centered">
                <Buttons>
                    @if (SetMode == FormMode.ReadOnly)
                    {
                        <CipherUpdateCategoryBtn ObjectId="@ChosenObject?.Id" />
                    }
                </Buttons>
                <ChildContent>
                    <CipherAutoComplete Label="@(ICategory.Translate(nameof(ICategory.Name)))" 
                                        Icon="@Icons.Symbols.category" @ref=CatName 
                                        ValueChanged="@ChangeDetail"
                                        Disabled="@ReadonlyFields()"
                                        Value="@ChosenObject?.Name" />
                    <CipherAutoComplete Label="@(ICategory.Translate(nameof(ICategory.Description)))" 
                                        Icon="@Icons.Documents.Page.description" 
                                        Multiline="true" 
                                        ValueChanged="@ChangeDetail"
                                        @ref=CatDescription
                                        Disabled="@ReadonlyFields()"
                                        Value="@ChosenObject?.Description" />
                    <CipherCategoryDropDown 
                        Label="@(ICategory.Translate(nameof(ICategory.Parent)))" 
                        @ref=ParentCat 
                        Change="@(args => ChangedParent((ICategory?)args))"
                                            Disabled="@ReadonlyFields()"
                                            ChosenCategory="@ChosenObject?.Parent" />
                    <CipherProcesses 
                        Icon="@Icons.Arrows.Squared.input" 
                        Label="@(ICategory.Translate(nameof(ICategory.CreatingProcesses)))" 
                        @ref=InProcs 
                        Change="@ChangeDetail"
                                     Disabled="@ReadonlyFields()" ChosenProcesses="@ChosenObject?.CreatingProcesses" />
                    <CipherProcesses Icon="@Icons.Arrows.Squared.output" Label="@(ICategory.Translate(nameof(ICategory.ConsumingProcesses)))" @ref=OutProcs Change="@ChangeDetail"
                                     Disabled="@ReadonlyFields()" ChosenProcesses="@ChosenObject?.ConsumingProcesses" />
                    <CipherMask @ref=CatMask Disabled="@ReadonlyFields()"
                                SelectedTexts="@ChosenObject?.IdMask.ToHashSet()" ValueChanged="@ChangeDetail" />
                </ChildContent>
            </CipherComponentCard>
            <CipherCategoryProperties @ref=CatProperties ValueChanged="@ChangeDetail" Disabled="@ReadonlyFields()"
                                      ChosenProperties="@SetProperties()" />
        }
    </ChildContent>
</CipherComponentCard>

@code {
    /// <summary>
    /// Define the usage of this object-card
    /// </summary>
    [Parameter]
    public FormMode SetMode { get; set; } = FormMode.Create;

    /// <summary>
    /// Chosen category within the card
    /// </summary>
    [Parameter]
    public ICategory? ChosenObject { get; set; }

    /// <summary>
    /// Event that takes place upon changing the category.
    /// </summary>
    [Parameter]
    public EventCallback<object> ChangeObject { get; set; }

    /// <summary>
    /// Event that takes place upon changing a detail of the object.
    /// </summary>
    [Parameter]
    public EventCallback ChangeDetails { get; set; }

    private CipherCategoryDropDown CatId = new();
    private CipherCategoryDropDown ParentCat = new();
    private CipherAutoComplete CatName = new();
    private CipherAutoComplete CatDescription = new();
    private CipherMask CatMask = new();
    private CipherProcesses InProcs = new();
    private CipherProcesses OutProcs = new();
    private CipherCategoryProperties CatProperties = new();

    private ICategory? Parent;
    private List<ICategoryProperty>? ParentProps;

    protected override void OnInitialized()
    {
        Title ??= "פרטי הקטגוריה";
        SetDetails();
    }

    public List<ICategoryProperty> SetProperties()
    {
        List<ICategoryProperty> result = new();
        result = ChosenObject?.Properties ?? result;

        if (CatProperties != null && CatProperties.ChosenProperties != null)
        {
            if (CatProperties.ChosenProperties.Any()) result = CatProperties.ChosenProperties;
        }

        return ParentProps ?? result;
    }

    public bool ReadonlyFields()
        => SetMode == FormMode.ReadOnly || (SetMode == FormMode.Update && ChosenObject is null);

    public void Change()
    {
        ChosenObject = CatId.ChosenCategory;
        //SetDetails();
        ChangeObject.InvokeAsync();
    }

    public void SetDetails()
    {
        if (ChosenObject is null) return;

        ParentCat.ChosenCategory = ChosenObject.Parent;
        CatName.Value = ChosenObject.Name;
        CatDescription.Value = ChosenObject.Description;
        InProcs.ChosenProcesses = ChosenObject.CreatingProcesses;
        OutProcs.ChosenProcesses = ChosenObject.ConsumingProcesses;
        CatProperties.ChosenProperties = ChosenObject.Properties;
        CatMask.SelectedTexts = ChosenObject.IdMask.ToHashSet();
    }

    public void ChangeDetail()
    {
        if (ChosenObject is null) return;
        ChosenObject.Parent = ParentCat.ChosenCategory;
        ChosenObject.Name = CatName.Value;
        ChosenObject.Description = CatDescription.Value;
        ChosenObject.CreatingProcesses = InProcs.ChosenProcesses;
        ChosenObject.ConsumingProcesses = OutProcs.ChosenProcesses;
        ChosenObject.Properties = CatProperties.ChosenProperties;
        ChosenObject.IdMask = CatMask.GetValue();
        ChangeDetails.InvokeAsync();
    }

    /// <summary>
    /// Method to set properties according to category's parent's properties.
    /// </summary>
    public void ChangedParent(ICategory? parent)
    {
        ParentCat.ChosenCategory = parent;

        Parent = parent;
        ParentProps = null;

        if (parent != null && parent.Properties != null) ParentProps = parent.Properties;

        ChangeDetail();
    }
}