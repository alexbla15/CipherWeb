@using System.Text.RegularExpressions;

@code {
    /// <summary>
    /// Component width.
    /// </summary>
    [Parameter]
    public string Width { get; set; } = "300px";

    /// <summary>
    /// Component's label.
    /// </summary>
    [Parameter]
    public string Label { get; set; }

    /// <summary>
    /// Placeholder for autocomplete.
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; }

    /// <summary>
    /// Component's style.
    /// </summary>
    [Parameter]
    public string Style { get; set; }

    /// <summary>
    /// Component's side icon.
    /// </summary>
    [Parameter]
    public string Icon { get; set; }

    /// <summary>
    /// Property of @Data to show as text-value within AutoComplete.
    /// </summary>
    [Parameter]
    public string TextProperty { get; set; }

    /// <summary>
    /// Allowed regex pattern for value. Defaulted to only letters / numbers / space / period
    /// </summary>
    [Parameter]
    public string AllowedRegex { get; set; } = "^[a-zA-Z0-9א-ת. \n]+$";

    /// <summary>
    /// Is the component disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Is the error message a popup / regular underline text.
    /// </summary>
    [Parameter]
    public bool Popup { get; set; }

    /// <summary>
    /// Is the value required for the form.
    /// </summary>
    [Parameter]
    public bool Required { get; set; } = true;

    /// <summary>
    /// Allow/disable error-messages.
    /// </summary>
    [Parameter]
    public bool ShowErrors { get; set; } = true;

    /// <summary>
    /// Allow/disable multiline autocomplete
    /// </summary>
    [Parameter]
    public bool Multiline { get; set; } = false;

    /// <summary>
    /// Is valid
    /// </summary>
    [Parameter]
    public bool IsValid { get; set; } = true;

    private string _value = "";

    /// <summary>
    /// Component's value.
    /// </summary>
    [Parameter]
    public string Value
    {
        get => _value;
        set
        {
            if (_value != value)
            {
                _value = value;
                ValueChanged.InvokeAsync(value);
            }
        }
    }

    /// <summary>
    /// AutoComplete options.
    /// </summary>
    [Parameter]
    public IEnumerable<object> Data { get; set; }

    /// <summary>
    /// Minimal amount of chars.
    /// </summary>
    [Parameter]
    public int MinLength { get; set; } = 0;

    /// <summary>
    /// Maximal amount of chars.
    /// </summary>
    [Parameter]
    public int MaxLength { get; set; } = int.MaxValue;

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    [Parameter]
    public EventCallback<object> Change { get; set; }

    /// <summary>
    /// Key pressed event.
    /// </summary>
    [Parameter]
    public EventCallback<KeyboardEventArgs> OnKeyDown { get; set; }

    private string LengthValidatorText()
    {
        return $"{MinLength}-{MaxLength} תווים. ";
    }

    class Model
    {
        public string value = "";
    }

    Model model = new Model() { value = "" };
    RadzenRequiredValidator RequiredValidator = new RadzenRequiredValidator();
    RadzenLengthValidator LengthValidator = new RadzenLengthValidator();
    RadzenRegexValidator ImproperCharsValidator = new RadzenRegexValidator();
    RadzenCustomValidator SqlInjectionValidator = new RadzenCustomValidator();
    RadzenCustomValidator ValueExistsValidator = new RadzenCustomValidator();

    private string[] unwantedWords = { "SELECT", "INSERT", "UPDATE", "DELETE", "PUT", "POST", "GET" };

    public string ImproperCharsValidatorText()
    {
        if (!string.IsNullOrEmpty(model.value))
        {
            Regex regex = new Regex(AllowedRegex, RegexOptions.IgnoreCase);
            var invalidChars = model.value.Where(c => !regex.IsMatch(c.ToString())).ToList();

            if (invalidChars.Any())
            {
                return "לא ניתן להשתמש בתו " + invalidChars[0] + ". ";
            }
            else
            {
                return "";
            }

        }
        return "";
    }

    public bool SqlInjectionValidate(string set_value)
    {
        string pattern = string.Join("|", unwantedWords);
        Regex regex = new Regex(pattern, RegexOptions.IgnoreCase);

        return !regex.IsMatch(set_value);
    }

    public string SqlInjectionValidatorText()
    {
        string pattern = string.Join("|", unwantedWords);
        Regex regex = new Regex(pattern, RegexOptions.IgnoreCase);

        if (string.IsNullOrEmpty(model.value))
        {
            return "";
        }
        else
        {
            if (regex.IsMatch(model.value))
            {
                Match match = regex.Match(model.value);
                return "אסור להשתמש במילה " + match.Value + ". ";
            }
            else
            {
                return "";
            }
        }
    }

    public bool Check()
    {
        IsValid = RequiredValidator.IsValid && LengthValidator.IsValid && ImproperCharsValidator.IsValid && SqlInjectionValidator.IsValid;
        return IsValid;
    }

    private void OnValueChanged(object value)
    {
        if (value is string stringValue)
        {
            model.value = stringValue;
            Value = stringValue;
        }
    }

    protected override void OnInitialized()
    {
        Placeholder = Placeholder ?? Label;
        model.value = Value; // Initialize model's value with the parameter value
    }

    public override async Task SetParametersAsync(ParameterView parameters)
    {
        await base.SetParametersAsync(parameters);

        if (parameters.TryGetValue<string>(nameof(Value), out var newValue))
        {
            model.value = newValue; // Synchronize model's value with the new parameter value
        }
    }
}

<RadzenTemplateForm TItem="Model" Data=@model>
    <RadzenStack Orientation="Orientation.Vertical" Gap="0">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Start" AlignItems="AlignItems.Center" Gap="5px">
            @if (!string.IsNullOrEmpty(Icon))
            {
                <style>
                    .rz-messages-error {
                        display: flex;
                        font-size: small;
                        padding-right: 2.5rem;
                    }
                </style>
                <RadzenIcon Icon="@Icon" IconColor="@Colors.PrimaryDark" Style="font-size: xx-large;" />
            }
            @if (string.IsNullOrEmpty(Label))
            {
                <RadzenAutoComplete @bind-Value=@model.value Name="setvalue" Placeholder="@Placeholder" Style="@($"{Style}; width: {Width}")" Disabled="@Disabled" onkeydown="@OnKeyDown"
                                    Data="@Data" TextProperty="@TextProperty" Change="@(EventCallback.Factory.Create(this, OnValueChanged))" 
                                    Multiline="@Multiline"/>
            }
            else
            {
                <RadzenFormField Variant=Variant.Flat Text="@Label" Style="@($"width:{Width};")">
                    <RadzenAutoComplete @bind-Value=@model.value Name="setvalue" Placeholder="@Placeholder" Style="@Style" Disabled="@Disabled" onkeydown="@OnKeyDown"
                                        Data="@Data" TextProperty="@TextProperty" Change="@(EventCallback.Factory.Create(this, OnValueChanged))"
                                        Multiline="@Multiline" />
                </RadzenFormField>
            }
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Vertical">
            @if (Required && ShowErrors)
            {
                <RadzenRequiredValidator @ref="RequiredValidator" Component="setvalue" Text="שדה חובה" Popup=@Popup />
            }
            <RadzenLengthValidator @ref=LengthValidator Component="setvalue" Min="@MinLength" Max="@MaxLength" Text="@LengthValidatorText()"
                                   Visible="@(RequiredValidator.IsValid && ShowErrors)" />
            <RadzenRegexValidator @ref=ImproperCharsValidator Component="setvalue" Pattern="@AllowedRegex" Text="@ImproperCharsValidatorText()" Visible=@(ShowErrors) />
            <RadzenCustomValidator @ref=SqlInjectionValidator Component="setvalue" Text="@SqlInjectionValidatorText()" Validator="(() => SqlInjectionValidate(model.value))" Visible=@(ShowErrors) />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>