@inject ICipherInfo _db
@inject DialogService DialogService

@inherits CipherSteps

<CipherSteps>
    <RadzenStepsItem Text="קביעת פרמטרים">
        <CipherComponentCard Title="בחירת שם לדוח" ContentDisplay="flex" ContentJustify="flex-start" ContentFlexWrap="wrap">
            <CipherAutoComplete Label="מספר סידורי" Icon="@Icons.Cipher.Id" Value="@ReportId.ToString()" Disabled="true"></CipherAutoComplete>
                <CipherAutoComplete Label="שם הדוח" Icon="@Icons.Documents.Edit._Edit"></CipherAutoComplete>
        </CipherComponentCard>
        <CipherParametrization></CipherParametrization>
    </RadzenStepsItem>

    <RadzenStepsItem Text="אובייקטים לתצוגה">
        <SearchAdvanced />
    </RadzenStepsItem>

    <RadzenStepsItem Text="בניית תצוגה">
        <CipherDataGrouper Cipher_TItem="Package" Title="בחירת קבוצות" groupLevels=1 @ref=dataGrouper></CipherDataGrouper>

        <CipherDataAggregater @ref=dataAggregater Title="בחירת שדות ופונקציות"
                              AggregationFields="@dataFilterPackages.FilterFields.ToList()"></CipherDataAggregater>

        <CipherComponentCard Title="תצוגה מקדימה">
            <Buttons>
                <CipherButton Icon="@Icons.Arrows.Rounded.Refresh" HelpText="עדכון תצוגה" Click="@OnRefresh" Variant="Variant.Outlined"></CipherButton>
                <CipherButton Icon="@Icons.Documents.Edit.Save" HelpText="שמירת דוח" Variant="Variant.Outlined"></CipherButton>
                <CipherExcelButton Data="@db_events"></CipherExcelButton>
                <CipherPDFButton></CipherPDFButton>
            </Buttons>
            <ChildContent>
                <CipherDataGrid ColumnNames="@GetColumns()" DataSource="@rows" ColumnsOrder="@rowsColumnsOrder" />
            </ChildContent>
        </CipherComponentCard>
    </RadzenStepsItem>
    <RadzenStepsItem Text="תצוגה מקדימה ושמירה">

        <CipherComponentCard BackgroundColor="@Colors.PrimaryLight">
            <CipherRestriction></CipherRestriction>
            <br />
            <CipherComponentCard Title="פרמטרים" ContentDisplay="flex" ContentJustify="flex-start" ContentFlexWrap="wrap">
                <CipherDatePicker Label="תאריך התחלה"></CipherDatePicker>
                <CipherDatePicker Label="תאריך סיום"></CipherDatePicker>
            </CipherComponentCard>
            <CipherEventsTable WithHeaderContent="false" WithCard="true"></CipherEventsTable>
            <CipherComponentCard Title="סיום" >
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center" Gap="10px">
                    <CipherSubmitButton Size="ButtonSize.Medium" Click="@OpenSavingDialog"/>
                    <CipherNavButton ColorStyle="ButtonStyle.Danger" Variant="Variant.Outlined" Icon="@Icons.Documents.Delete.Cancel" 
                    Text="ביטול" Path="@CipherNavLinks.Reports.Href" Size="ButtonSize.Medium"></CipherNavButton>
                </RadzenStack>
            </CipherComponentCard>
        </CipherComponentCard>
    </RadzenStepsItem>
</CipherSteps>

@code {
    private List<Event> db_events = new List<Event>();

    private CipherDataGrouper<Package> dataGrouper = new CipherDataGrouper<Package>();
    private CipherDataFilter_WithDataGrid<Event> dataFilter = new CipherDataFilter_WithDataGrid<Event>();
    private CipherDataFilter_WithDataGrid<Package> dataFilterPackages = new CipherDataFilter_WithDataGrid<Package>();
    private CipherDataAggregater dataAggregater = new CipherDataAggregater();
    
    private List<Package> packs = Package.All().Item1;
    private List<Package> rows = Package.All().Item1;
    private Dictionary<string, int> rowsColumnsOrder = new Dictionary<string, int> { };

    private int ReportId;

    class ExampleSummary
    {
        public string Location { get; set; }
        public string Vessel { get; set; }
        public decimal BrutMass { get; set; }
        public decimal NetMass { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        db_events = await _db.GetEvents();

        Random random = new Random();
        ReportId = random.Next(1000,9999);
    }

    /// <summary>
    /// Get translation between (english, hebrew) column names for table.
    /// </summary>
    /// <returns></returns>
    private HashSet<Tuple<string, string>> GetColumns()
    {
        if (dataGrouper.chosenGroups.Keys.Count() == 0 && dataAggregater.GetData().Count() == 0)
        {
            return HebrewDictionary.Headers;
        }
        else
        {
            return HebrewDictionary.Headers.Where(x =>
                dataGrouper.chosenGroups.ContainsValue(x.Item2) ||
                dataAggregater.GetData().Select(x => x.Parameter).ToList().Contains(x.Item2)
            ).ToHashSet();
        }
    }

    /// <summary>
    ///  Set the columns order within datagrid.
    /// </summary>
    void SetColumnsOrder()
    {
        rowsColumnsOrder.Clear();

        // first columns must be the grouped-by columns
        foreach (int order in dataGrouper.chosenGroups.Keys)
        {
            if (!string.IsNullOrEmpty(dataGrouper.chosenGroups[order]))
            {
                rowsColumnsOrder.Add(CommonFuncs.DeTranslateField(dataGrouper.chosenGroups[order]), order);
            }
        }

        int counter = dataGrouper.groupLevels;

        // next columns according to the order of the aggregation
        List<CipherDataAggregater.Aggregate> aggregates = dataAggregater.GetData();

        foreach (CipherDataAggregater.Aggregate agg in aggregates)
        {
            if (!rowsColumnsOrder.ContainsKey(agg.Parameter))
            {
                rowsColumnsOrder.Add(agg.Parameter, agg.Id);
            }
            counter += 1;
        }
    }

    /// <summary>
    /// Updating datagrid table to show results.
    /// </summary>
    public void OnRefresh()
    {
        rows = new List<Package>();

        List<string> vessels = TestedData.Vessels.Select(x => x.Id).Distinct().ToList();

        foreach (StorageSystem sys in TestedData.Systems)
        {
            foreach (Vessel ves in TestedData.Vessels)
            {
                Package pack = Package.Random();
                pack.System = sys;
                pack.Vessel = ves;
                pack.BrutMass = packs.Where(x => x.System.Id == sys.Id && x.Vessel.Id == ves.Id).Select(x => x.BrutMass).Sum();
                pack.NetMass = packs.Where(x => x.System.Id == sys.Id && x.Vessel.Id == ves.Id).Select(x => x.NetMass).Sum();
                rows.Add(pack);
            }
        }
        SetColumnsOrder();
    }


    public async Task OpenSavingDialog()
    {
        await DialogService.OpenAsync("דוח חדש",

        ds =>
    @<CipherComponentCard WithCard="false">
        <CipherComponentCard WithCard="false" ContentDisplay="flex" ContentJustify="flex-start" ContentFlexWrap="wrap">
            <CipherAutoComplete Label="מספר הדוח" Value="111111"/>
            <CipherAutoComplete Label="שם הדוח" Value="הדוח שלי"/>
            <CipherAutoComplete Label="מידור" Value="מוגבל"/>
        </CipherComponentCard>
        <br/>
        <CipherButton Text="קישור לדוח" Icon="@Icons.Arrows.Squared.OpenInNew" Width="100%" />
    </CipherComponentCard>
    
    , Constants.SetDialogOptions);
    }
}