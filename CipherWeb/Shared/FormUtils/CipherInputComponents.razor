@inject DialogService DialogService

@inherits CipherComponentCard

@code {
    [Parameter]
    public TextAlign TdTextAlign { get; set; } = TextAlign.Right;

    /// <summary>
    /// Text shown in case no rows were added.
    /// </summary>
    [Parameter]
    public string HelpText { get; set; } = "במסך זה ניתן להוסיף תעודות מוסרות. להוספה לחצו על כפתור ההוספה למעלה";

    /// <summary>
    /// Help text for add-button.
    /// </summary>
    [Parameter]
    public string AddText { get; set; } = "הוספת תעודה מוסרת";

    /// <summary>
    /// Help text for delete-all-button.
    /// </summary>
    [Parameter]
    public string DeleteAllText { get; set; } = "מחיקת תעודות";

    /// <summary>
    /// All packages available
    /// </summary>
    [Parameter]
    public List<Package> allPacks { get; set; } = new List<Package>();

    /// <summary>
    /// All chosen packeges
    /// </summary>
    [Parameter]
    public List<Package> chosenPacks { get; set; } = new List<Package>();

    /// <summary>
    /// Error response for fetching data
    /// </summary>
    [Parameter]
    public ErrorResponse error { get; set; } = ErrorResponse.Success;

    private RadzenDataGrid<Package> CustomDataGrid;

    private bool ShowHelpText = true;
    private int components = 0;

    protected override void OnInitialized()
    {
        Title ??= "תעודות מוסרות";

        (allPacks, error) = CachedData.AllPackages;
    }

    /// <summary>
    /// Add a component to the memory.
    /// </summary>
    async Task AddComponent()
    {
        // Add the new restriction to the existing list
        chosenPacks.Add(Package.Empty());

        StateHasChanged();

        components = chosenPacks.Count;

        ShowHelpText = false;

        RefreshOptionalPackages();

        await CustomDataGrid.RefreshDataAsync();
    }

    /// <summary>
    /// Get total sum of masses of package-components.
    /// </summary>
    /// <returns></returns>
    public decimal GetTotal()
    {
        return chosenPacks.Sum(pack => pack.BrutMass);
    }

    /// <summary>
    /// Deletes a package-component from memory & view.
    /// </summary>
    /// <param name="pack">Package to delete</param>
    async Task DeleteRow(Package pack)
    {
        chosenPacks.Remove(pack);

        RefreshOptionalPackages();

        CustomDataGrid.Data = chosenPacks;

        components--;

        await CustomDataGrid.RefreshDataAsync();

        if (chosenPacks.Count() == 0)
        {
            ShowHelpText = true;
        }
    }

    /// <summary>
    /// Clears all package-components from memory & view.
    /// </summary>
    /// <returns></returns>
    async Task DeleteAll()
    {
        chosenPacks.Clear();
        components = 0;
        CustomDataGrid.Data = chosenPacks;

        await CustomDataGrid.RefreshDataAsync();
        
        RefreshOptionalPackages();

        ShowHelpText = true;
    }

    /// <summary>
    /// Remove used packages from options, preventing duplicity.
    /// </summary>
    public void RefreshOptionalPackages()
    {
        // refresh options
        (allPacks, error) = CachedData.AllPackages;
        allPacks.RemoveAll(p => chosenPacks.Any(x => x.Id == p.Id));
    }
}

<CipherComponentCard Title="@Title" Visible="@Visible">
    <Buttons>
        <CipherAddBtn Variant="Variant.Outlined" Click="@(args => AddComponent())" HelpText="@AddText" />
        <CipherButton Icon="@Icons.Documents.Delete.DeleteSweep" Variant="Variant.Outlined" Click="@(args => DeleteAll())" HelpText="@DeleteAllText" />
    </Buttons>
    <ChildContent>
        @if (ShowHelpText)
        {
            <CipherText Text="@HelpText" Visible="@ShowHelpText" />
        }
        <RadzenDataGrid @ref="CustomDataGrid" Data="@chosenPacks" TItem="Package" AllowColumnResize="true" Visible="!components.Equals(0)">
            <Columns>
                <RadzenDataGridColumn Width="10%" TItem="Package" Title="פעולות" Filterable="false" Sortable="false" TextAlign="@TdTextAlign">
                    <Template Context="pack">
                        <CipherDeleteButton Variant=Variant.Outlined Click="@(args => DeleteRow(pack))" @onclick:stopPropagation="true" />
                    </Template>
                </RadzenDataGridColumn>
                @*<RadzenDataGridColumn TItem="Package" Property="@(nameof(CachedData.PackageExample.Uuid))" Title="#" Width="10%" SortOrder="SortOrder.Ascending" TextAlign="@TdTextAlign" />*@
                <RadzenDataGridColumn TItem="Package" Title="@(Package.Translate(nameof(CachedData.PackageExample.Id)))" Width="40%" TextAlign="@TdTextAlign">
                    <Template Context="pack">
                        <RadzenDropDownDataGrid Placeholder="@(Package.Translate(nameof(CachedData.PackageExample.Id)))" SearchTextPlaceholder="חיפוש..." TValue="string"
                                                Data=@allPacks TextProperty="@(nameof(CachedData.PackageExample.Id))"
                                                ValueProperty="@(nameof(CachedData.PackageExample.Id))" AllowFilteringByAllStringColumns="true"
                                                Style="@($"width: {Width}; min-height:;")" @bind-Value="@pack.Id">
                            <Columns>
                                <RadzenDropDownDataGridColumn Property="@(nameof(CachedData.PackageExample.Id))" Title="@(Package.Translate(nameof(CachedData.PackageExample.Id)))" />
                                <RadzenDropDownDataGridColumn Property="@(nameof(CachedData.PackageExample.Category.MaterialType))" Title="@(Category.Translate(nameof(CachedData.CategoryExample.MaterialType)))">
                                    <Template>
                                        @((context as Package).Category.MaterialType?.Name)
                                    </Template>
                                </RadzenDropDownDataGridColumn>
                                <RadzenDropDownDataGridColumn Property="@(nameof(CachedData.PackageExample.Category))" Title="@(Package.Translate(nameof(CachedData.PackageExample.Category)))">
                                    <Template>
                                        @(string.Join(", ", (context as Package).Category.Name))
                                    </Template>
                                </RadzenDropDownDataGridColumn>
                            </Columns>
                        </RadzenDropDownDataGrid>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Package" Title="@(Package.Translate(nameof(CachedData.PackageExample.BrutMass)))" Width="40%" TextAlign="@TdTextAlign">
                    <Template Context="pack">
                        <CipherNumeric Width="100%" Amount="Package.Get(pack.Id).Item1.BrutMass" Disabled="true" Visible="@(!string.IsNullOrEmpty(pack.Id))" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Package" Title="מסה ברוטו מועברת [גר']" Width="40%" TextAlign="@TdTextAlign">
                    <Template Context="pack">
                        <CipherNumeric @bind-Amount="@pack.BrutMass" Width="100%" Max="Package.Get(pack.Id).Item1.BrutMass" ShowErrors="true" Visible="@(!string.IsNullOrEmpty(pack.Id))" />
                    </Template>
                    <FooterTemplate>
                        מסה כוללת: @GetTotal()
                    </FooterTemplate>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </ChildContent>
</CipherComponentCard>