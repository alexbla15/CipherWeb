@page "/Approval"

@using System.Reflection

@inject ICipherInfo _db
@inject IJSRuntime JSRuntime
@inject ExcelService excelService
@inject DialogService DialogService

@code {
    TextStyle HeaderTextStyle = TextStyle.H5;
}

<PageTitle>אישור תנועות</PageTitle>

<CipherDataFilter_WithDataGrid Title="סינון תנועות לאישור" Cipher_TItem="Event" WithCustomDataGrid=true FilterFields="@FilterFields">
    <Buttons>
        <CipherButton Icon="@Icons.Symbols.V.DoneAll" HelpText="אישור כל התנועות" Variant="Variant.Outlined"></CipherButton>
        <CipherButton Icon="@Icons.Documents.Delete.DeleteSweep" HelpText="דחיית כל התנועות" Variant="Variant.Outlined"></CipherButton>
        <CipherExcelButton Data="@events"></CipherExcelButton>
        <CipherPDFButton></CipherPDFButton>
    </Buttons>
    <CustomDataGrid>
        <CipherDataGrid @ref="CustomDataGrid" WithCustomColumns="true"
                        GridFilterMode="FilterMode.Simple" AllowFilter="false"
                        AllowSort="true" AllowGroup="false" HideGroupedColumn="true"
                        AllGroupsExpanded="false"
                        DataSource="@events">
            <CustomColumns>
                <RadzenDataGridColumn TItem="Event" Title="אישור" Width="100px">
                    <Template>
                        <CipherButton ColorStyle="ButtonStyle.Success" Icon="@Icons.Symbols.V.Check"
                                      Variant="Variant.Flat" ColorShade="Shade.Default"
                                      Size="ButtonSize.Medium" />
                        <CipherButton ColorStyle="ButtonStyle.Danger" Icon="@Icons.Documents.Delete.Cancel"
                                      Variant="Variant.Flat" ColorShade="Shade.Default"
                                      Size="ButtonSize.Medium" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Event" Property="@(nameof(CachedData.EventExample.EventType))" Title="@(Event.Translate(nameof(CachedData.EventExample.EventType)))" />
                <RadzenDataGridColumn TItem="Event" Property="@(nameof(CachedData.EventExample.ProcessId))" Title="@(Event.Translate(nameof(CachedData.EventExample.ProcessId)))" />
                <RadzenDataGridColumn TItem="Event" Property="@(nameof(CachedData.EventExample.Timestamp))" Title="@(Event.Translate(nameof(CachedData.EventExample.Timestamp)))" />
                <RadzenDataGridColumn TItem="Event" Title="תעודה מוסרת">
                    <Template>
                        @if (context.Packages.ToList().Count() > 0)
                        {
                            @context.Packages.ToList().First().Id
                            ;
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="Event" Title="מערכת מוסרת">
                    <Template>
                        <RadzenText Text="A"></RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Event" Title="תעודה מקבלת">
                    <Template>
                        @if (context.Packages.ToList().Count() > 0)
                        {
                            @context.Packages.ToList().Last().Id
                            ;
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Event" Title="מערכת מקבלת">
                    <Template>
                        <RadzenText Text="B"></RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Event" Title="מסת תנועה">
                    <Template>
                        <RadzenText Text="5"></RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Event" Property="@(nameof(CachedData.EventExample.Comments))" Title="@(Event.Translate(nameof(CachedData.EventExample.Comments)))" />
                <RadzenDataGridColumn TItem="Event" Property="@(nameof(CachedData.EventExample.Status))" Title="@(Event.Translate(nameof(CachedData.EventExample.Status)))">
                    <Template>
                        @((context.Status == 0) ? "מאומתת" : "לא מאומתת")
                    </Template>
                </RadzenDataGridColumn>
            </CustomColumns>
        </CipherDataGrid>
    </CustomDataGrid>
</CipherDataFilter_WithDataGrid>
<CipherButton Icon="@Icons.Documents.Edit.Save" Text="שמירת אישורים" Variant="Variant.Outlined" Width="100%"></CipherButton>

@code {
    /// <summary>
    /// All events available
    /// </summary>
    [Parameter]
    public List<Event> events { get; set; } = new List<Event>();

    /// <summary>
    /// Error response for fetching data
    /// </summary>
    [Parameter]
    public ErrorResponse error { get; set; } = ErrorResponse.Success;

    RadzenDataGrid<Event> CustomDataGrid;

    private List<Tuple<string, string>> FilterFields = new List<Tuple<string, string>>();

    protected override void OnInitialized()
    {
        (events, error) = CachedData.AllEvents;

        FilterFields.AddRange(new List<Tuple<string, string>>()
        {
        new (nameof(CachedData.EventExample.Timestamp), Event.Translate(nameof(CachedData.EventExample.Timestamp))),
        new ("DonatingSystem", "מערכת מוסרת"),
        new ("AcceptingSystem", "מערכת מקבלת"),
        new ("DonatingPackage", "תעודה מוסרת"),
        new ("AcceptingPackage", "תעודה מקבלת"),
        new ("EventMass", "מסת תנועה"),
        });
        FilterFields.AddRange(Event.GetHebrewTranslations<Event>().ToList());
    }

    ButtonStyle GetStatusColor(string status)
    {
        return status switch
        {
            EventStatus.Pending => ButtonStyle.Secondary,
            EventStatus.Accepted => ButtonStyle.Success,
            EventStatus.Denied => ButtonStyle.Danger,
            EventStatus.Warning => ButtonStyle.Warning,
            _ => ButtonStyle.Primary
        };
    }

    public async Task OpenEvent()
    {
        await DialogService.OpenAsync("תנועה",

        ds =>
    @<CipherEventCard dir="rtl" WithCard=false ReadOnly=false></CipherEventCard>, Constants.SetDialogOptions);
    }
}