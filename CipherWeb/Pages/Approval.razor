@page "/Approval"

@using System.Reflection

<PageTitle>@Title</PageTitle>

<RadzenStack Orientation="Orientation.Vertical">
    <CipherBooleanConditions @ref="EventsFilter" Title="סינון תנועות לאישור" OnSave="@RefreshEvents" />
    <CipherJsonCheck JsonValue="@JsonRequest" />
    <CipherDisplayedEventsCard Title="@Title" @bind-Events="@PendingEvents" @ref="FilterableEvents"
        WithRowButtons="true"/>
    <CipherDisplayedEventsCard Title="תנועות מאושרות" @bind-Events="@ApprovedEvents" />
    <CipherDisplayedEventsCard Title="תנועות דחויות" @bind-Events="@DeclinedEvents" />
</RadzenStack>

@code {
    /// <summary>
    /// All events in queue for approval
    /// </summary>
    [Parameter]
    public List<IEvent> PendingEvents { get; set; } = new();

    /// <summary>
    /// All approved events
    /// </summary>
    [Parameter]
    public List<IEvent> ApprovedEvents { get; set; } = new();

    /// <summary>
    /// All declined events
    /// </summary>
    [Parameter]
    public List<IEvent> DeclinedEvents { get; set; } = new();

    /// <summary>
    /// Page Title.
    /// </summary>
    [Parameter]
    public string? Title { get; set; }

    /// <summary>
    /// Json request that will be sent to the API server.
    /// </summary>
    [Parameter]
    public string JsonRequest { get; set; } = string.Empty;

    /// <summary>
    /// API response to submission.
    /// </summary>
    [Parameter]
    public ErrorResponse Error { get; set; } = ErrorResponse.Success;

    private CipherBooleanConditions EventsFilter = new();
    private CipherDisplayedEventsCard FilterableEvents = new();

    protected override async Task OnInitializedAsync()
    {
        Title ??= CipherNavLinks.Approval.Name;

        (PendingEvents, Error) = await Config.Event.PendingEvents();
        (ApprovedEvents, Error) = await Config.Event.ApprovedEvents();
        (DeclinedEvents, Error) = await Config.Event.DeclinedEvents();
    }

    public async Task RefreshEvents()
    {
        IGroupedBooleanCondition filterValue = EventsFilter.ChosenCondition;
        IObjectFactory objectFactory = Config.ObjectFactory;

        // add to filter - only pending events
        List<ICondition> originalFilterValue = filterValue.Conditions.ToList();

        var cond = Config.BooleanCondition;
        cond.Attribute = $"[Event].[{nameof(IEvent.Status)}]";
        cond.AttributeRelation = AttributeRelation.Eq;
        cond.Value = "0";

        originalFilterValue.Add(cond);
        filterValue.Conditions = originalFilterValue;

        objectFactory.Filter = filterValue;

        // order by time (1), and system-id (2)

        IOrderedItem orderedItem = Config.OrderedItem;
        orderedItem.Attribute = $"[Event].[{nameof(IEvent.Timestamp)}]";
        orderedItem.Order = Order.desc;
        objectFactory.AddOrderBy(orderedItem);

        orderedItem = Config.OrderedItem;
        orderedItem.Attribute = $"[Event].[{nameof(IEvent.FinalStatePackages)}].[{nameof(IPackage.System)}].[{nameof(IStorageSystem.Id)}]";
        orderedItem.Order = Order.desc;
        objectFactory.AddOrderBy(orderedItem);
        
        var result = await Config.QueryRequests.QueryObjects<IEvent>(objectFactory);
        (PendingEvents, Error) = Tuple.Create(result.Item1.Cast<IEvent>().ToList(), result.Item2);

        JsonRequest = objectFactory.ToJson();
        await FilterableEvents.ChangeEvents(PendingEvents);
    }
}