@using System.Reflection;
@using CipherWeb.Pages.Forms
@inject NavigationManager Navigation

@typeparam Cipher_TItem

<ResourceForm @ref="ResourcePage" Title="@NavLink.Name">
    @if (typeof(Cipher_TItem) == typeof(IUnit))
    {
        <CipherUnitCard Title="" WithCard="false" @ref="@unitCard" ChangeObject="ChangeUrl" 
            ChosenObject="@(ChosenObject as IUnit)" SetMode="FormMode.ReadOnly" />
    }
    else if (typeof(Cipher_TItem) == typeof(IVessel))
    {
        <CipherVesselCard Title="" WithCard="false" @ref="@vesCard" ChangeObject="ChangeUrl" 
            ChosenObject="@(ChosenObject as IVessel)" SetMode="FormMode.ReadOnly" />
    }
    else if (typeof(Cipher_TItem) == typeof(IStorageSystem))
    {
        <CipherSystemCard Title="" WithCard="false" @ref="@sysCard" ChangeObject="ChangeUrl" 
            ChosenObject="@(ChosenObject as IStorageSystem)" SetMode="FormMode.ReadOnly" />
    }
    else if (typeof(Cipher_TItem) == typeof(IPackage))
    {
        <CipherPackageCard Title="" WithCard="false" @ref="@packCard" ChangeObject="ChangeUrl" 
            ChosenObject="@(ChosenObject as IPackage)" SetMode="FormMode.ReadOnly" />
    }
    else if (typeof(Cipher_TItem) == typeof(IProcessDefinition))
    {
        <CipherProcessCard Title="" WithCard="false" @ref="@procCard" ChangeObject="ChangeUrl" 
            ChosenObject="@(ChosenObject as IProcessDefinition)" SetMode="FormMode.ReadOnly" />
    }
    else if (typeof(Cipher_TItem) == typeof(ICategory))
    {
        <CipherCategoryCard Title="" WithCard="false" @ref="@catCard" ChangeObject="ChangeUrl" 
            ChosenObject="@(ChosenObject as ICategory)" SetMode="FormMode.ReadOnly" />
    }
    @if (ObjectHistory != null)
    {
        <CipherObjectChangesTable ObjectChanges="@ObjectHistory" />
    }
</ResourceForm>

@code {
    /// <summary>
    /// Page nav link.
    /// </summary>
    [Parameter]
    public CipherNavLink? NavLink { get; set; }

    /// <summary>
    /// Chosen object upon searching
    /// </summary>
    [Parameter]
    public Cipher_TItem? ChosenObject { get; set; }

    /// <summary>
    /// All of object historic changes
    /// </summary>
    [Parameter]
    public IUserActionResponse? ObjectHistory { get; set; }

    /// <summary>
    /// API response to search.
    /// </summary>
    [Parameter]
    public ErrorResponse Error { get; set; } = ErrorResponse.Success;

    private CipherUnitCard unitCard = new();
    private CipherVesselCard vesCard = new();
    private CipherSystemCard sysCard = new();
    private CipherPackageCard packCard = new();
    private CipherProcessCard procCard = new();
    private CipherCategoryCard catCard = new();

    private ResourceForm ResourcePage = new();

    /// <summary>
    /// Chosen objects mapping dictionary
    /// </summary>
    private Dictionary<Type, Func<object?>> chosenObjectMap = new();

    protected override async Task OnInitializedAsync()
    {
        SetChosenObjMap();
        await GetObjectFromUrl();
        GetObjectHistory();
    }

    private async Task GetObjectFromUrl()
    {
        string? id = ResourcePage.GetIdFromUrl(Navigation);

        if (typeof(Cipher_TItem) == typeof(IUnit))
        {
            var result = await Config.Unit().Get(id);
            (ChosenObject, Error) = Tuple.Create((Cipher_TItem)result.Item1, result.Item2);
        }
        else if (typeof(Cipher_TItem) == typeof(ICategory))
        {
            var result = await Config.Category().Get(id);
            (ChosenObject, Error) = Tuple.Create((Cipher_TItem)result.Item1, result.Item2);
        }
        else if (typeof(Cipher_TItem) == typeof(IVessel))
        {
            var result = await Config.Vessel().Get(id);
            (ChosenObject, Error) = Tuple.Create((Cipher_TItem)result.Item1, result.Item2);
        }
        else if (typeof(Cipher_TItem) == typeof(IProcessDefinition))
        {
            //var result = await Config.ProcessDefinition().Get(id);
            //(ChosenObject, Error) = Tuple.Create((Cipher_TItem)result.Item1, result.Item2);
        }
        else if (typeof(Cipher_TItem) == typeof(IStorageSystem))
        {
            var result = await Config.StorageSystem().Get(id);
            (ChosenObject, Error) = Tuple.Create((Cipher_TItem)result.Item1, result.Item2);
        }
    }

    public void SetChosenObjMap()
    {
        chosenObjectMap = new Dictionary<Type, Func<object?>>
        {
            { typeof(IUnit), () => unitCard.ChosenObject },
            { typeof(IVessel), () => vesCard.ChosenObject },
            { typeof(IStorageSystem), () => sysCard.ChosenObject },
            { typeof(IPackage), () => packCard.ChosenObject },
            { typeof(IProcessDefinition), () => procCard.ChosenObject },
            { typeof(ICategory), () => catCard.ChosenObject },
        };
    }

    /// <summary>
    /// Changes URL to include the chosen-unit id, upon searching it within the page.
    /// </summary>
    public void ChangeUrl()
    {
        ChosenObject = GetChosenObject();
        ResourcePage.ChangeUrl(Navigation, NavLink, GetObjectId(ChosenObject));
        GetObjectHistory();
    }

    /// <summary>
    /// Get the chosen object based on its type.
    /// </summary>
    private Cipher_TItem? GetChosenObject()
    {
        if (chosenObjectMap.TryGetValue(typeof(Cipher_TItem), out var chosenObjectFunc))
        {
            return (Cipher_TItem?)chosenObjectFunc?.Invoke();
        }
        return default;
    }

    /// <summary>
    /// Retrieve the object's ID for URL changes.
    /// </summary>
    private string? GetObjectId(object? obj) => (obj as IResource)?.Id;

    /// <summary>
    /// Method to get object history from UserActions function within the Resource-object
    /// </summary>
    public void GetObjectHistory()
    {
        if (ChosenObject == null)
        {
            (ObjectHistory, Error) = (null, ErrorResponse.Success);
            return;
        }

        MethodInfo? methodInfo = typeof(Cipher_TItem).GetMethod("UserActions");

        if (methodInfo != null)
        {
            var Result = methodInfo.Invoke(ChosenObject, null);
            if (Result is Tuple<IUserActionResponse?, ErrorResponse> tupleResult)
            {
                (ObjectHistory, Error) = tupleResult;
            }
        }
    }
}
